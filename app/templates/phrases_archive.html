{% extends "base.html" %}

{% block title %}ë¬¸êµ¬ ì•„ì¹´ì´ë¸Œ - ë§ˆì¼€íŒ… ë¬¸êµ¬ ìƒì„± AI{% endblock %}

{% block extra_css %}
<style>
    .section {
        margin-bottom: 40px;
    }
    .section h2 {
        color: #6d67a8;
        margin-bottom: 20px;
        font-size: 24px;
    }
    .archive-item {
        background: #f8f9fa;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        border-left: 4px solid #764ba2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .archive-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .archive-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        flex: 1;
    }
    .archive-date {
        font-size: 14px;
        color: #666;
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 4px;
        white-space: nowrap;
    }
    .archive-message {
        font-size: 16px;
        color: #555;
        margin-bottom: 12px;
        line-height: 1.6;
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
        max-width: 100%;
        overflow-wrap: break-word;
    }
    .archive-meta {
        display: grid;
        grid-template-columns: 1fr auto auto auto auto auto;
        gap: 10px;
        font-size: 13px;
        align-items: start;
    }
    .meta-item-target {
        grid-column: 1;
        background: white;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
        word-break: break-word;
    }
    .meta-item {
        background: white;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
        min-width: 80px;
        text-align: center;
    }
    .meta-label {
        font-weight: bold;
        color: #495057;
        display: block;
        margin-bottom: 2px;
    }
    .meta-value {
        color: #007bff;
        font-weight: bold;
    }
    .performance-high {
        border-left-color: #28a745;
    }
    .performance-medium {
        border-left-color: #ffc107;
    }
    .performance-low {
        border-left-color: #dc3545;
    }
    .filter-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }
    select.team-selector, select.sort-selector, select.channel-selector {
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        min-width: 200px;
        font-size: 14px;
    }
    select.team-selector:focus, select.sort-selector:focus, select.channel-selector:focus {
        border-color: #6d67a8;
        outline: none;
    }
    .sort-title {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    .sort-title h3 {
        color: #6d67a8;
        margin: 0;
        font-size: 20px;
    }
    
    .warning-text {
        font-size: 12px;
        color: #ff6b6b;
        margin: 5px 0 0 0;
        font-style: italic;
    }
    .loading {
        text-align: center;
        color: #999;
        padding: 20px;
    }
    .empty-state {
        text-align: center;
        color: #999;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h2>ğŸ“š íŒ€ë³„ ë¬¸êµ¬ ì•„ì¹´ì´ë¸Œ</h2>
    <p style="color: #666; margin-bottom: 20px;">íŒ€ì„ ì„ íƒí•˜ì—¬ ê³¼ê±°ì— ìƒì„±ëœ ë§ˆì¼€íŒ… ë¬¸êµ¬ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    
    <div class="filter-controls">
        <select class="team-selector" id="team-selector" onchange="loadArchive()">
            <option value="">íŒ€ ì„ íƒ</option>
            <option value="1">ê·¸ë¡œìŠ¤ë§ˆì¼€íŒ…íŒ€ (407ê°œ ë¬¸êµ¬)</option>
            <option value="3">ë²„í‹°ì»¬ë§ˆì¼€íŒ…íŒ€ (214ê°œ ë¬¸êµ¬)</option>
            <option value="4">ë§ˆì¼€íŒ…ìš´ì˜íŒ€ (137ê°œ ë¬¸êµ¬)</option>
            <option value="9">ì‹í’ˆíŒ€ (27ê°œ ë¬¸êµ¬)</option>
            <option value="2">ì—¬í–‰ì„œë¹„ìŠ¤TFT (12ê°œ ë¬¸êµ¬)</option>
            <option value="8">ë¦¬ë¹™íŒ€ (10ê°œ ë¬¸êµ¬)</option>
            <option value="5">ìŠ¤í¬ì¸ ë ˆì €íŒ€ (8ê°œ ë¬¸êµ¬)</option>
            <option value="13">b tft (4ê°œ ë¬¸êµ¬)</option>
            <option value="10">ìœ ì•„ë™íŒ¨ì…˜íŒ€ (3ê°œ ë¬¸êµ¬)</option>
            <option value="14">ëª…í’ˆì¡í™”íŒ€ (3ê°œ ë¬¸êµ¬)</option>
            <option value="11">L.TOWNíŒ€ (5ê°œ ë¬¸êµ¬)</option>
            <option value="16">B2BíŒ€ (2ê°œ ë¬¸êµ¬)</option>
            <option value="6">íŒ¨ì…˜íŒ€ (2ê°œ ë¬¸êµ¬)</option>
            <option value="7">ë¸Œëœë“œë·°í‹°íŒ€ (1ê°œ ë¬¸êµ¬)</option>
            <option value="12">ì œíœ´ì„œë¹„ìŠ¤ìƒí’ˆíŒ€ (1ê°œ ë¬¸êµ¬)</option>
            <option value="15">ë¸Œëœë“œíŒ¨ì…˜íŒ€ (1ê°œ ë¬¸êµ¬)</option>
            <option value="17">ë””ì§€í„¸ê°€ì „íŒ€ (1ê°œ ë¬¸êµ¬)</option>
        </select>
        
        <select class="channel-selector" id="channel-selector" onchange="loadArchive()">
            <option value="">ì±„ë„ ì„ íƒ</option>
            <option value="RCS">RCS</option>
            <option value="APP_PUSH">ì•±í‘¸ì‹œ</option>
        </select>
        
        <select class="sort-selector" id="sort-selector" onchange="loadArchive()">
            <option value="latest">ìµœì‹ ìˆœ 10ê°œ</option>
            <option value="conversion_rate">ì „í™˜ìœ¨ ë†’ì€ ìˆœ 10ê°œ</option>
            <option value="ctr">CTR ë†’ì€ ìˆœ 10ê°œ</option>
            <option value="impression_count">ë…¸ì¶œìˆ˜ ë†’ì€ ìˆœ 10ê°œ</option>
            <option value="click_count">í´ë¦­ìˆ˜ ë†’ì€ ìˆœ 10ê°œ</option>
            <option value="conversion_count">ì „í™˜ìˆ˜ ë†’ì€ ìˆœ 10ê°œ</option>
        </select>
    </div>
    
    <div id="archive-container">
        <div class="empty-state">
            <p>íŒ€ì„ ì„ íƒí•˜ë©´ ê³¼ê±° ë¬¸êµ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function loadArchive() {
        const container = document.getElementById('archive-container');
        const teamId = document.getElementById('team-selector').value;
        const sortBy = document.getElementById('sort-selector').value;
        const channel = document.getElementById('channel-selector').value;
        
        if (!teamId) {
            container.innerHTML = '<div class="empty-state"><p>íŒ€ì„ ì„ íƒí•˜ë©´ ê³¼ê±° ë¬¸êµ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>';
            return;
        }
        
        container.innerHTML = '<div class="loading">ë¬¸êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        // ì±„ë„ í•„í„°ë§ì„ ìœ„í•œ URL íŒŒë¼ë¯¸í„° ì¶”ê°€
        let url = `/api/archive?team_id=${teamId}&sort_by=${sortBy}&limit=10`;
        if (channel) {
            url += `&channel=${channel}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayArchive(data.copies, sortBy);
                } else {
                    container.innerHTML = `<div class="empty-state"><p>ì˜¤ë¥˜: ${data.error}</p></div>`;
                }
            })
            .catch(error => {
                container.innerHTML = `<div class="empty-state"><p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p></div>`;
            });
    }
    
    function displayArchive(copies, sortBy) {
        const container = document.getElementById('archive-container');
        
        if (!copies || copies.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>ì•„ì§ ì €ì¥ëœ ë¬¸êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            return;
        }
        
        // ì¤‘ë³µ ì œê±°í•˜ë©´ì„œ ìµœëŒ€ 10ê°œê¹Œì§€ ì±„ìš°ê¸°
        const finalCopies = [];
        const seenContent = new Set();
        
        // ì²« ë²ˆì§¸ íŒ¨ìŠ¤: ì¤‘ë³µ ì œê±°í•˜ë©´ì„œ ìµœëŒ€ 10ê°œê¹Œì§€ ì±„ìš°ê¸°
        for (const copy of copies) {
            // ì•±í‘¸ì‹œì˜ ê²½ìš° copy_idë¡œ ì¤‘ë³µ ì œê±°, RCSì˜ ê²½ìš° ë‚´ìš©ìœ¼ë¡œ ì¤‘ë³µ ì œê±°
            const contentKey = copy.copy_id ? `id_${copy.copy_id}` : `${copy.title || ''}|${copy.message || ''}`;
            if (!seenContent.has(contentKey)) {
                seenContent.add(contentKey);
                finalCopies.push(copy);
                
                // 10ê°œê°€ ë˜ë©´ ì¤‘ë‹¨
                if (finalCopies.length >= 10) {
                    break;
                }
            }
        }
        
        // ë‘ ë²ˆì§¸ íŒ¨ìŠ¤: 10ê°œê°€ ì•ˆ ë˜ë©´ ë‚˜ë¨¸ì§€ ìœ ë‹ˆí¬í•œ ë¬¸êµ¬ë¡œ ì±„ìš°ê¸°
        if (finalCopies.length < 10) {
            for (const copy of copies) {
                const contentKey = copy.copy_id ? `id_${copy.copy_id}` : `${copy.title || ''}|${copy.message || ''}`;
                if (!seenContent.has(contentKey)) {
                    seenContent.add(contentKey);
                    finalCopies.push(copy);
                    
                    // 10ê°œê°€ ë˜ë©´ ì¤‘ë‹¨
                    if (finalCopies.length >= 10) {
                        break;
                    }
                }
            }
        }
        
        // ì‹¤ì œ ë°ì´í„° ê°œìˆ˜ë§Œí¼ë§Œ í‘œì‹œ
        const actualCount = finalCopies.length;
        
        // ì •ë ¬ ê¸°ì¤€ì— ë”°ë¥¸ ì œëª© ì„¤ì • (ì‹¤ì œ ê°œìˆ˜ ë°˜ì˜)
        const sortTitles = {
            'latest': `ìµœì‹ ìˆœ ${actualCount}ê°œ`,
            'conversion_rate': `ì „í™˜ìœ¨ ë†’ì€ ìˆœ ${actualCount}ê°œ`,
            'ctr': `CTR ë†’ì€ ìˆœ ${actualCount}ê°œ`,
            'impression_count': `ë…¸ì¶œìˆ˜ ë†’ì€ ìˆœ ${actualCount}ê°œ`,
            'click_count': `í´ë¦­ìˆ˜ ë†’ì€ ìˆœ ${actualCount}ê°œ`,
            'conversion_count': `ì „í™˜ìˆ˜ ë†’ì€ ìˆœ ${actualCount}ê°œ`
        };
        
        const sortTitle = sortTitles[sortBy] || `ë¬¸êµ¬ ëª©ë¡ (${actualCount}ê°œ)`;
        
        const html = `
            <div class="sort-title">
                <h3>ğŸ“Š ${sortTitle}</h3>
                ${actualCount < 10 ? '<p class="warning-text">âš ï¸ ì¤‘ë³µ ë¬¸êµ¬ ì œê±°ë¡œ ì¸í•´ 10ê°œ ë¯¸ë§Œìœ¼ë¡œ í‘œì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>' : ''}
            </div>
            ${finalCopies.map((copy, index) => {
            // ì„±ê³¼ì— ë”°ë¥¸ í´ë˜ìŠ¤ ê²°ì •
            const conversionRate = copy.conversion_rate || 0;
            let performanceClass = 'performance-low';
            if (conversionRate > 0.1) performanceClass = 'performance-high';
            else if (conversionRate > 0.05) performanceClass = 'performance-medium';
            
            // ì±„ë„ì— ë”°ë¥¸ ë¼ë²¨ ì„¤ì •
            const channel = document.getElementById('channel-selector').value;
            const titleLabel = channel === 'RCS' ? 'ë²„íŠ¼' : 'ì œëª©';
            const messageLabel = channel === 'RCS' ? 'ë©”ì‹œì§€' : 'ë‚´ìš©';
            
            return `
                <div class="archive-item ${performanceClass}">
                    <div class="archive-header">
                        <div class="archive-title">#${index + 1} ${titleLabel}: ${copy.title || 'ì—†ìŒ'}</div>
                        <div class="archive-date">${copy.send_date || 'N/A'}</div>
                    </div>
                    <div class="archive-message"><strong>${messageLabel}:</strong> ${copy.message || 'ì—†ìŒ'}</div>
                    <div class="archive-meta">
                        <div class="meta-item-target">
                            <span class="meta-label">íƒ€ê²Ÿ</span>
                            <span class="meta-value">${copy.target_audience || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">ì „í™˜ìœ¨</span>
                            <span class="meta-value">${(conversionRate * 100).toFixed(1)}%</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">CTR</span>
                            <span class="meta-value">${((copy.ctr || 0) * 100).toFixed(1)}%</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">ë…¸ì¶œìˆ˜</span>
                            <span class="meta-value">${(copy.impression_count || 0).toLocaleString()}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">í´ë¦­ìˆ˜</span>
                            <span class="meta-value">${(copy.click_count || 0).toLocaleString()}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">ì „í™˜ìˆ˜</span>
                            <span class="meta-value">${(copy.conversion_count || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
        `;
        
        container.innerHTML = html;
    }
</script>
{% endblock %}
